## 优化整个流程

第一步：优化数据管道

保留高开低收字段，后续回溯检验需要使用开盘价。

第二步：优化分析脚本

同步数据分析和创建报告模版。

- 设置参数，标准分数窗口，开始时间和结束时间，初始资本？
- 计算标准分数
- 生成信号
- 运行向量化回溯检验
- 计算业绩指标
- 绘图

创建自定义类`VectorizedBacktest`，将模块存储到`src`文件夹。提供公共接口实现统一的回溯检验，并提供辅助函数来统计历史交易，计算业绩指标和绘图。

输入数据：
- 数据框，索引为时间序列，必需包含'open','close','signal'三个字段。
- 信号是包含(-1,0,1)的序列，1表示做多，-1表示做空，0表示空仓。
- 为了避免前视偏误，在下一根k线的开盘价进场和平仓。

提供辅助函数实现：
- 获取所有历史交易：`get_trades`
- 计算业绩指标：`get_performence_stats`
- 绘图：`plot_backtest_result`

历史交易需要包含以下字段：
- 进场时间
- 进场价
- 平仓时间
- 平仓价
- 头寸（默认为1个单位资产）
- 盈亏（百分比）

业绩指标
- 交易基础指标(trade-based metrics)：根据历史交易计算，包括总交易次数，胜率，盈利因子等核心指标
- 收益率基础指标(return-based metrics)：使用`ffn`库计算，包括CAGR,总收益率，夏普比率核心指标。

绘图可视化净值曲线和信号，使用`plotly`实现。

测试并优化函数，根据测试结果完善报告模版。

`position`的计算逻辑似乎有误：

2014-11-05收盘时信号为-1，那么11-06开盘时应该做空，当天的position应该为-1。
2014-11-06收盘时信号为+1，那么11-07开盘时应该先把空头平仓，然后做多，当天的position应该为+1。

11-06:
- 11-05收盘，信号为-1
- 开盘时做空，进场价=339.5
- 持仓一天，收盘价=349.3
- 当天收盘=`-2.9%`

11-07:
- 11-06收盘，信号为+1，需要平仓空头并做多
- 11-07开盘，先平仓空头，再做多，并持有一天多头
- 平仓空头：平仓价=349.8，进场价（昨天收盘）=349.3，收益=`-0.14%`
- 多头进场：进场价=349.8，日内收盘=342.4，当天持仓收益=`-2.1%`
- 总损益：`-2.23%`

创建`VectorizedBacktestV2`,使用for循环来实现回溯检验，其核心计算逻辑保持不变，根据前一根K线的收盘信号，以当前k线的开盘价进场和平仓。

交易记录应该添加一个字段，"status", 分为持仓(open)和已平仓(closed)，trade-based metrics根据已平仓交易进行计算。
回测逻辑应该包含最后一笔交易，假设持仓直到数据框最后一天，假设在最后一天的收盘价平仓，但状态显示为“持仓”。

完善报告模版。

第三步：优化内容生成

如何生成内容？

- 根据数据生成分析报告，类似周报，发布到博客平台，英文。
- 基于报告生成推文，发布到社媒平台（推特，币安广场）。

实现方式：
1. 自定义脚本 - 麻烦，需要维护代码。
2. opencode, 自定义代理，自定义技能 - 新途径。
