## 优化整个流程

### 第一步：优化数据管道

保留高开低收字段，后续回溯检验需要使用开盘价。

### 第二步：优化分析脚本

同步数据分析和创建报告模版。

- 设置参数，标准分数窗口，开始时间和结束时间，初始资本？
- 计算标准分数
- 生成信号
- 运行向量化回溯检验
- 计算业绩指标
- 绘图

创建自定义类`VectorizedBacktest`，将模块存储到`src`文件夹。提供公共接口实现统一的回溯检验，并提供辅助函数来统计历史交易，计算业绩指标和绘图。

输入数据：
- 数据框，索引为时间序列，必需包含'open','close','signal'三个字段。
- 信号是包含(-1,0,1)的序列，1表示做多，-1表示做空，0表示空仓。
- 为了避免前视偏误，在下一根k线的开盘价进场和平仓。

提供辅助函数实现：
- 获取所有历史交易：`get_trades`
- 计算业绩指标：`get_performence_stats`
- 绘图：`plot_backtest_result`

历史交易需要包含以下字段：
- 进场时间
- 进场价
- 平仓时间
- 平仓价
- 头寸（默认为1个单位资产）
- 盈亏（百分比）

业绩指标
- 交易基础指标(trade-based metrics)：根据历史交易计算，包括总交易次数，胜率，盈利因子等核心指标
- 收益率基础指标(return-based metrics)：使用`ffn`库计算，包括CAGR,总收益率，夏普比率核心指标。

绘图可视化净值曲线和信号，使用`plotly`实现。

交易记录应该添加一个字段，"status", 分为持仓(open)和已平仓(closed)，trade-based metrics根据已平仓交易进行计算。
回测逻辑应该包含最后一笔交易，假设持仓直到数据框最后一天，假设在最后一天的收盘价平仓，但状态显示为“持仓”。

### 第三步：优化内容生成

如何生成内容？

1. `analysis.py`，分析模块要输出关键数据和图片。
2. 使用opencode skills创建文章和推文。

为什么plan代理会读取那么多文件？

需要修改`agent.md`，marimo notebook不需要测试，测试普通脚本要经过用户同意。

如何使用opencode创建skills？

- 让opencode生成初步文件
- 根据最优实践修改文件
- 测试并优化

技术总结：
- 如何创建skill.md
- 总结创建技能文档的最佳实践。
