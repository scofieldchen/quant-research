## duckdb

什么是duckdb?

进程内SQL数据库管理系统。

嵌入式（in-process）数据库管理系统，不需要安装和管理数据库服务器，直接在python进程内运行。

列式存储和向量化执行引擎，操作速度比pandas更快，内存占用更少。

与pandas/polars无缝集成，能够直接查询pandas对象。

可以直接对csv, json, parquet文件执行sql查询，无需把数据先导入传统数据库。 

如何使用duckdb?

```
duckdb.sql(sql_query)
```

## 分析计划

第一步：读取数据

第二步：计算核心指标，进行向量化回溯检验

核心指标：sth-mvrv标准分数：`zscore(log(sth_mvrv),n)`

交易策略：
- 标准分数高于0，做多
- 标准分数低于0，做空
- 使用向量化回溯检验（核心逻辑：将信号转化为头寸）
- 使用`ffn`计算业绩指标

第三步：数据可视化

主图：
- BTC 价格曲线（对数坐标）。
- 信号层：不要画线，要画“背景色带”。
  - 绿色背景：策略持有看多头寸区间。
  - 红色背景：策略持有看空头寸区间。
  - 灰色背景：空仓观望。
副图：STH-MVRV Z-Score 震荡指标。
- 在 0 轴画强力支撑/阻力线。
- 在 +2 和 -2 画虚线警戒线。
- 使用渐变色填充（Gradient Fill），数值越高颜色越热。


## 优化代码

优化sth_mvrv.py, 创建新脚本sth_mvrv_v2.py

工作流：

1. 创建ui，允许用户选择参数
  - 标准分数窗口：数值输入，默认值为50 
  - 开始时间：日期输入，默认为2024-01-01
  - 结束时间：日期输入，默认为今天
2. 获取数据
  - 使用duckdb作为查询引擎
  - 读取数据时要包含（开始时间-lookback） -> 结束时间，lookback为计算指标需要的回溯期
3. 计算sth_mvrv的标准分数
  - 沿用`sth_mvrv.py`的计算公式
4. 可视化指标
5. 进行向量化回溯检验（复用`sth_mvrv.py`的函数）
6. 可视化回溯检验的结果

最终结果为marimo notebook，使用app模式运行时得到一个美观的数据分析app。

app页面结构包含几个部分：
- 选择参数
- 可视化指标（sth mvrv标准分数）
- 可视化回溯结果
- 使用二级标题来分隔内容

图表要求美观，适合发布到博客平台和社交媒体。

`find_trend_periods`函数可能有bugs，需要进一步调试，背景色中间可能包含空白范围。

添加一些文本，说明指标解读，算法，回测，模型的优缺点等。
